<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>VT Men's Basketball ‚Äî Sideline Analytics</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind + Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    html,body{height:100%;margin:0}
    .dark-mode{background:#111827 !important;color:#f9fafb}
    .light-mode{background:#f9fafb !important;color:#111827}
    .selectlike{appearance:none;background-image:linear-gradient(45deg,transparent 50%,currentColor 50%),linear-gradient(135deg,currentColor 50%,transparent 50%);background-position:calc(100% - 18px) calc(50% - 3px),calc(100% - 12px) calc(50% - 3px);background-size:6px 6px,6px 6px;background-repeat:no-repeat}
    .suggestion{cursor:pointer}
    .tbl th{font-weight:700}
    .tbl th,.tbl td{padding:.6rem .75rem;white-space:nowrap}
    .pill{padding:.4rem .6rem;border-radius:.5rem}
  </style>
</head>
<body class="dark-mode">
  <div id="root"></div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDmUDcy18ZWk_EgOSlLsk9CgzQaKVxcfG4",
      authDomain: "vtmbb-playcalls.firebaseapp.com",
      databaseURL: "https://vtmbb-playcalls-default-rtdb.firebaseio.com",
      projectId: "vtmbb-playcalls",
      storageBucket: "vtmbb-playcalls.firebasestorage.app",
      messagingSenderId: "329877987847",
      appId: "1:329877987847:web:d4d33227dc39624ae100a2",
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>

  <script type="text/babel">
    const {useState,useEffect,useMemo,useRef,useCallback} = React;

    function App(){
      // THEME
      const [dark,setDark]=useState(true);
      useEffect(()=>{document.body.className=dark?'dark-mode':'light-mode';},[dark]);

      // DATA SCOPE
      const [season,setSeason]=useState('2025');
      const [playData,setPlayData]=useState(null);
      const [loading,setLoading]=useState(true);
      const [updated,setUpdated]=useState(null);

      // SEARCH + SELECTION
      const [seriesQuery,setSeriesQuery]=useState('');                     // CHANGE: series-only search text
      const [selectedSeries,setSelectedSeries]=useState(null);             // CHANGE: selected series name (e.g., "Alpha")
      const [selectedPlay,setSelectedPlay]=useState(null);                 // CHANGE: selected play object {series, playNumber}

      // TABLE SORT
      const [topSortByN,setTopSortByN]=useState(true);                     // CHANGE: allow clicking "Times Called" to sort Top 3
      const [botSortByN,setBotSortByN]=useState(true);                     // CHANGE: allow clicking "Times Called" to sort Bottom 3

      // CHARTS
      const donutRef=useRef(null), donutInst=useRef(null);
      const barRef=useRef(null), barInst=useRef(null);

      // Load from Firebase (live listener)
      const load=useCallback(()=>{
        setLoading(true);
        const dbRef= database.ref(`playcalls/${season}/stats/series`);
        const listener = dbRef.on('value', (snap) => {
          setPlayData(snap.exists() ? snap.val() : null);
          setUpdated(new Date().toLocaleString());
          setLoading(false);
        }, (error) => {
          console.error("Error: ", error);
          setLoading(false);
        });
        return () => {dbRef.off('value', listener);};
      },[season]);

      useEffect(()=>load(),[load]);

      // SERIES LIST
      const allSeries=useMemo(()=> playData?Object.keys(playData).sort():[],[playData]);

      // Build flat index for stats and counts
      const flat=useMemo(()=>{
        if(!playData) return [];
        const out=[];
        Object.keys(playData).forEach(series=>{
          const plays=playData[series]||{};
          Object.keys(plays).forEach(num=>{
            const s=plays[num]||{};
            const n=parseInt(s.NumCalls||s.numCalls)||0;
            if(n<=0) return;
            const pts=(+s['+2']||0)*2+(+s['+3']||0)*3+(+s['+2F']||0)*2+(+s['+3F']||0)*3;
            const ppp=n?pts/n:0;
            out.push({series,playNumber:num,n,ppp,stats:s});
          });
        });
        return out;
      },[playData]);

      // Suggest series by N (frequency)
      const seriesCounts=useMemo(()=>{
        const map={};
        flat.forEach(r=>{ map[r.series]=(map[r.series]||0)+r.n; });
        return map;
      },[flat]);

      const seriesSuggestions=useMemo(()=>{
        const q=seriesQuery.trim().toLowerCase();
        const pool=allSeries.map(s=>({series:s,total:(seriesCounts[s]||0)}));
        const filtered=q?pool.filter(x=>x.series.toLowerCase().includes(q)):pool;
        // CHANGE: show only first 3 rows, rest scrollable via CSS; we still compute all for height control
        return filtered.sort((a,b)=> b.total-a.total || a.series.localeCompare(b.series));
      },[seriesQuery,allSeries,seriesCounts]);

      // TOP/BOTTOM 3 within selected series (or global if none chosen)
      const scopeRows=useMemo(()=>{
        const pool = selectedSeries ? flat.filter(r=>r.series===selectedSeries) : flat;
        return pool;
      },[flat,selectedSeries]);

      const top3=useMemo(()=>{
        const rows=[...scopeRows].sort((a,b)=> b.ppp-a.ppp || b.n-a.n).slice(0,3);
        // allow Times Called sorting toggle (still keeps only these 3)
        return topSortByN ? [...rows].sort((a,b)=> b.n-a.n || b.ppp-a.ppp) : rows;
      },[scopeRows,topSortByN]);

      const bottom3=useMemo(()=>{
        const rows=[...scopeRows].sort((a,b)=> a.ppp-b.ppp || b.n-a.n).slice(0,3);
        return botSortByN ? [...rows].sort((a,b)=> b.n-a.n || a.ppp-b.ppp) : rows;
      },[scopeRows,botSortByN]);

      // DETAIL CARD: either aggregate for series, or specific play
      const detailStats=useMemo(()=>{
        if(!selectedSeries) return null;
        if(selectedPlay && selectedPlay.series===selectedSeries){
          return playData?.[selectedSeries]?.[selectedPlay.playNumber] || null;
        }
        // Aggregate all plays in series
        const playsInSeries=playData?.[selectedSeries]||{};
        const agg={NumCalls:0,'+2':0,'+3':0,'+2F':0,'+3F':0,'-2':0,'-3':0,'-2F':0,'-3F':0,'NOTHING':0,'TO':0,FOF:0};
        Object.keys(playsInSeries).forEach(num=>{
          const s=playsInSeries[num]||{};
          const n=parseInt(s.NumCalls||s.numCalls)||0;
          agg.NumCalls+=n;
          ['+2','+3','+2F','+3F','-2','-3','-2F','-3F','NOTHING','TO'].forEach(k=> agg[k]+= (+s[k]||0) );
          agg.FOF+= (+s['+2F']||0)+(+s['+3F']||0)+(+s['-2F']||0)+(+s['-3F']||0);
        });
        return agg;
      },[selectedSeries,selectedPlay,playData]);

      const header=useMemo(()=>{
        if(!detailStats) return null;
        const n=parseInt(detailStats.NumCalls)||1;
        const pts=(+detailStats['+2']||0)*2+(+detailStats['+3']||0)*3+(+detailStats['+2F']||0)*2+(+detailStats['+3F']||0)*3;
        const ppp=n?pts/n:0;
        const made=['+2','+3','+2F','+3F'].reduce((s,k)=>s+(+detailStats[k]||0),0);
        const fg=n?(made/n)*100:0;
        return {n,ppp,fg,fof:detailStats.FOF||0};
      },[detailStats]);

      // Charts
      useEffect(()=>{
        if(!detailStats || !donutRef.current) return;
        if(donutInst.current) donutInst.current.destroy();
        const total=parseInt(detailStats.NumCalls)||1;
        const made=['+2','+3','+2F','+3F'].reduce((s,k)=>s+(+detailStats[k]||0),0);
        const missTo=['-2','-3','-2F','-3F'].reduce((s,k)=>s+(+detailStats[k]||0),0);
        const nothing=+detailStats.NOTHING||0;
        const to=+detailStats.TO||0;
        donutInst.current=new Chart(donutRef.current.getContext('2d'),{
          type:'doughnut',
          data:{labels:['Made FG','Miss/TO','Nothing','Turnover'],
                datasets:[{data:[made,missTo,nothing,to],
                           backgroundColor:['#10B981','#EF4444','#6B7280','#F59E0B']}]},
          options:{responsive:true,maintainAspectRatio:false,
            plugins:{legend:{position:'bottom',labels:{color:dark?'#fff':'#374151',padding:12}}}}
        });
      },[detailStats,dark]);

      useEffect(()=>{
        if(!detailStats || !barRef.current) return;
        if(barInst.current) barInst.current.destroy();
        const vals=[
          +detailStats['+3']||0,
          +detailStats['+2']||0,
          (+detailStats['-2']||0)+(+detailStats['-3']||0),
          +detailStats['+3F']||0,
          +detailStats['+2F']||0,
          (+detailStats['-2F']||0)+(+detailStats['-3F']||0)
        ];
        barInst.current=new Chart(barRef.current.getContext('2d'),{
          type:'bar',
          data:{labels:['3pt','2pt','No Score','3pt+Foul','2pt+Foul','Miss+Foul'],
                datasets:[{label:'Occurrences',data:vals,backgroundColor:'#3B82F6'}]},
          options:{responsive:true,maintainAspectRatio:false,
            scales:{y:{beginAtZero:true,ticks:{color:dark?'#9CA3AF':'#6B7280'},grid:{color:dark?'#374151':'#E5E7EB'}},
                    x:{ticks:{color:dark?'#9CA3AF':'#6B7280'},grid:{color:dark?'#374151':'#E5E7EB'}}},
            plugins:{legend:{display:false}}}
        });
      },[detailStats,dark]);

      // Helpers
      const playLabel = (r)=> `${r.series} ${r.playNumber}`;               // CHANGE: no dashes anywhere

      const clickPlayRow=(r)=>{
        // CHANGE: keep current series context; only set play within that series
        setSelectedSeries(r.series);
        setSelectedPlay({series:r.series,playNumber:r.playNumber});
      };

      const clearDetail=()=>{
        setSelectedPlay(null);
        setSelectedSeries(null);
      };

      return (
        <div className="max-w-7xl mx-auto p-4">
          {/* ===== HEADER with Live pill restored ===== */}
          <div className={`rounded-lg shadow p-4 mb-6 ${dark?'bg-gray-800':'bg-white'}`}>
            <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
              <div className="flex items-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/60/Virginia_Tech_Hokies_logo.svg/2560px-Virginia_Tech_Hokies_logo.svg.png" alt="VT" className="h-12"/>
                <h1 className="text-2xl font-bold">Sideline Analytics</h1>
              </div>
              <div className="flex items-center gap-2">
                <select value={season} onChange={(e)=>setSeason(e.target.value)}
                        className={`selectlike px-3 py-2 rounded border ${dark?'bg-gray-700 border-gray-600 text-white':'bg-white border-gray-300'}`}>
                  <option value="2024">Season 2024</option>
                  <option value="2025">Season 2025</option>
                </select>
                {/* CHANGE: Live pill (visual) */}
                <button type="button" className="flex items-center gap-2 px-3 py-2 rounded text-white bg-green-600 hover:bg-green-700 shadow">
                  <span className="w-2 h-2 rounded-full bg-green-300 animate-pulse" />
                  Live
                </button>
                <button onClick={()=>setDark(d=>!d)}
                        className={`px-3 py-2 rounded ${dark?'bg-gray-700 text-white hover:bg-gray-600':'bg-gray-200 text-gray-900 hover:bg-gray-300'}`}>{dark?'‚òÄÔ∏è Light':'üåô Dark'}</button>
              </div>
            </div>
            {updated && (
              <div className="flex items-center gap-2 mt-2">
                <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <div className="text-xs opacity-70">Live ‚Ä¢ {updated}</div>
              </div>
            )}
          </div>

          {/* Loading skeleton */}
          {loading && (
            <div className="animate-pulse space-y-4">
              <div className="h-16 bg-gray-300 rounded"></div>
              <div className="h-64 bg-gray-300 rounded"></div>
              <div className="h-96 bg-gray-300 rounded"></div>
            </div>
          )}

          {!loading && (
            <>
              {/* ===== Series-only Search ===== */}
              <div className={`rounded-lg shadow p-4 mb-4 ${dark?'bg-gray-800':'bg-white'}`}>
                <label className="text-sm block mb-1">Search series (e.g., <span className="opacity-80">Alpha</span> or <span className="opacity-80">November</span>)</label>
                <input
                  type="text"
                  value={seriesQuery}
                  onChange={(e)=>{ setSeriesQuery(e.target.value); }}
                  placeholder="Start typing‚Ä¶"
                  className={`w-full px-3 py-2 rounded border ${dark?'bg-gray-700 border-gray-600 text-white placeholder-gray-400':'bg-white border-gray-300'}`}
                />
                {/* CHANGE: dropdown shows only series names, first 3 visible then scrollable */}
                <div className={`mt-2 rounded-lg border ${dark?'border-gray-700':'border-gray-300'} max-h-40 overflow-y-auto`}>
                  {seriesSuggestions.length===0 && (
                    <div className={`px-3 py-2 text-sm ${dark?'text-gray-300':'text-gray-600'}`}>No matches.</div>
                  )}
                  {seriesSuggestions.map((s,idx)=>(
                    <div key={idx}
                      className={`suggestion px-3 py-2 flex items-center justify-between ${dark?'hover:bg-gray-800':'hover:bg-gray-100'}`}
                      onClick={()=>{ setSelectedSeries(s.series); setSelectedPlay(null); setSeriesQuery(s.series); }}>
                      <div className="font-medium">{s.series}</div>
                      <div className="text-xs opacity-75">N={s.total}</div>
                    </div>
                  ))}
                </div>
              </div>

              {/* ===== Top/Bottom 3 tables ===== */}
              <div className="grid lg:grid-cols-2 gap-4 mb-6">
                <div className={`rounded-lg shadow p-4 ${dark?'bg-gray-800':'bg-white'}`}>
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="text-lg font-bold">Top 3 by Points/Play</h2>
                    <span className="text-xs opacity-70">{selectedSeries ?? 'All Series'}</span>
                  </div>
                  <table className="tbl w-full">
                    <thead className={`${dark?'bg-gray-900 text-gray-200':'bg-gray-100 text-gray-700'}`}>
                      <tr>
                        <th className="text-left">Play</th>
                        {/* CHANGE: center-align numbers; make header clickable to toggle sort */}
                        <th className="text-center cursor-pointer select-none" onClick={()=>setTopSortByN(v=>!v)}>
                          Times Called {topSortByN? '‚ñæ':'‚ñ¥'}
                        </th>
                        <th className="text-right">Pts/Play</th>
                      </tr>
                    </thead>
                    <tbody>
                      {top3.length===0 && (<tr><td colSpan="3" className="py-3 text-sm opacity-70">No plays.</td></tr>)}
                      {top3.map((r,i)=>(
                        <tr key={`t-${i}`} className={`${dark?'hover:bg-gray-800':'hover:bg-gray-100'} cursor-pointer`} onClick={()=>clickPlayRow(r)}>
                          <td className="font-medium">{playLabel(r)}</td>
                          <td className="text-center">{r.n}</td>
                          <td className="text-right font-semibold text-green-400">{r.ppp.toFixed(2)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div className={`rounded-lg shadow p-4 ${dark?'bg-gray-800':'bg-white'}`}>
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="text-lg font-bold">Bottom 3 by Points/Play</h2>
                    <span className="text-xs opacity-70">{selectedSeries ?? 'All Series'}</span>
                  </div>
                  <table className="tbl w-full">
                    <thead className={`${dark?'bg-gray-900 text-gray-200':'bg-gray-100 text-gray-700'}`}>
                      <tr>
                        <th className="text-left">Play</th>
                        {/* CHANGE: center-align numbers; header toggles sort */}
                        <th className="text-center cursor-pointer select-none" onClick={()=>setBotSortByN(v=>!v)}>
                          Times Called {botSortByN? '‚ñæ':'‚ñ¥'}
                        </th>
                        <th className="text-right">Pts/Play</th>
                      </tr>
                    </thead>
                    <tbody>
                      {bottom3.length===0 && (<tr><td colSpan="3" className="py-3 text-sm opacity-70">No plays.</td></tr>)}
                      {bottom3.map((r,i)=>(
                        <tr key={`b-${i}`} className={`${dark?'hover:bg-gray-800':'hover:bg-gray-100'} cursor-pointer`} onClick={()=>clickPlayRow(r)}>
                          <td className="font-medium">{playLabel(r)}</td>
                          <td className="text-center">{r.n}</td>
                          <td className="text-right font-semibold text-red-400">{r.ppp.toFixed(2)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* ===== Detail card ===== */}
              {(selectedSeries && detailStats && header) && (
                <div className={`rounded-lg shadow p-6 ${dark?'bg-gray-800':'bg-white'}`}>
                  <div className="flex items-center justify-between mb-4">
                    {/* CHANGE: Title shows either "Alpha 7" or "Alpha" (no dashes, no '(All Plays)') */}
                    <h3 className="text-lg font-bold">
                      {selectedPlay ? `${selectedSeries} ${selectedPlay.playNumber}` : `${selectedSeries}`}
                    </h3>
                    <button className={`pill ${dark?'bg-gray-700':'bg-gray-200'}`} onClick={clearDetail}>Clear</button>
                  </div>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div>
                      <div className="text-sm opacity-75">Avg Points</div>
                      <div className={`text-2xl font-bold ${header.ppp>1.15?'text-green-500':header.ppp<0.95?'text-red-500':'text-blue-500'}`}>{header.ppp.toFixed(2)}</div>
                    </div>
                    <div>
                      <div className="text-sm opacity-75">Times Called</div>
                      {/* CHANGE: center in table already; here we keep big number */}
                      <div className="text-2xl font-bold">{header.n}</div>
                    </div>
                    <div>
                      <div className="text-sm opacity-75">FG %</div>
                      <div className={`text-2xl font-bold ${header.fg>43?'text-green-500':header.fg<37?'text-red-500':'text-blue-500'}`}>{header.fg.toFixed(1)}%</div>
                    </div>
                    <div>
                      <div className="text-sm opacity-75">Fouls on FGs</div>
                      <div className="text-2xl font-bold">{header.fof}</div>
                    </div>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <div className="text-sm font-semibold mb-2">Outcome Distribution</div>
                      <div style={{height:'260px'}}><canvas ref={donutRef}></canvas></div>
                    </div>
                    <div>
                      <div className="text-sm font-semibold mb-2">Scoring Breakdown</div>
                      <div style={{height:'260px'}}><canvas ref={barRef}></canvas></div>
                    </div>
                  </div>
                </div>
              )}
            </>
          )}
        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
